<!doctype html>
<html lang="zh" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Âä†ÂØÜÂ∏ÇÂú∫ Top 100 / Crypto Top 100</title>
  <meta name="color-scheme" content="dark">
  <style>
    /* ===== Design tokens ===== */
    :root{
      --bg: linear-gradient(135deg, #0f172a, #020617 60%, #000);
      --panel: rgba(17,24,39,.65);
      --card: rgba(17,24,39,.65);
      --text: #e5e7eb;
      --muted:#94a3b8;
      --border: rgba(148,163,184,.2);
      --brand:#2563eb; --ok:#16a34a; --down:#ef4444; --warn:#f59e0b;
      --shadow: 0 8px 26px rgba(0,0,0,.35);
      --radius: 14px; --focus: 0 0 0 3px color-mix(in srgb, var(--brand) 30%, transparent);
      --chip: rgba(255,255,255,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; color:var(--text); font:16px/1.6 Arial,Helvetica,sans-serif; background:var(--bg) fixed}
    a{color:inherit; text-decoration:none}
    .container{max-width:1200px; margin:0 auto; padding:20px}
    @media (max-width:1280px){ .container{padding-inline:16px} }
    @media (max-width:480px){ body{font-size:15px} }

    /* Header / toolbarÔºà‰øùÁïôÁßªÂä®Á´Ø‰øÆÂ§çÔºâ */
    .app-header{position:sticky; top:0; z-index:20; backdrop-filter:saturate(140%) blur(10px); background:var(--panel); border-bottom:1px solid var(--border)}
    .toolbar{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:nowrap}
    .brand{display:flex; align-items:center; gap:10px; padding:10px 0; font-weight:800; letter-spacing:.2px; min-width:0}
    .badge{display:inline-grid; place-items:center; width:36px; height:36px; border-radius:9px; background:linear-gradient(135deg,#2563eb 0%,#8b5cf6 100%); color:#fff; flex:0 0 auto}
    .brand span{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:38vw}
    .search{flex:1; display:flex; align-items:center; gap:8px; min-width:160px; max-width:520px; background:var(--card); padding:10px 12px; border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow)}
    .search input{flex:1; border:0; outline:0; background:transparent; font-size:15px; color:inherit; min-width:60px}
    .icon-btn{border:0; background:transparent; cursor:pointer; padding:10px; border-radius:10px; touch-action:manipulation}
    .icon-btn:hover{background:rgba(0,0,0,.06)}
    .chip-group{display:flex; gap:6px; background:var(--chip); padding:5px; border-radius:999px}
    .chip{border:0; cursor:pointer; padding:10px 12px; border-radius:999px; background:transparent; color:var(--muted); font-weight:700; touch-action:manipulation}
    .chip.is-active{background:#e2e8f0; color:#111827; box-shadow:0 6px 20px rgba(16,24,40,.18)}
    @media (max-width:720px){
      .toolbar{flex-wrap:wrap}
      .brand{order:1; flex:1 1 auto}
      .search{order:3; width:100%}
      .toolbar > .actions-bar{order:2; display:flex; gap:10px; align-items:center}
    }

    /* Hero / stats */
    .hero{margin:14px 0 10px; display:grid; gap:14px; grid-template-columns: 1.3fr 1fr}
    .panel{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px}
    .stats{display:grid; gap:10px; grid-template-columns: repeat(3,1fr)}
    .stat{display:flex; flex-direction:column; gap:2px}
    .stat .k{font-size:13px; color:var(--muted)}
    .stat .v{font-size:20px; font-weight:900}
    .delta.up{color:var(--ok)} .delta.down{color:var(--down)}
    @media (max-width:920px){ .hero{grid-template-columns:1fr} }
    @media (max-width:600px){ .stats{grid-template-columns:1fr 1fr} .stat .v{font-size:18px} }

    /* Table (desktop) */
    .table{margin-top:12px; background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); overflow:auto}
    table{width:100%; border-collapse:separate; border-spacing:0; min-width:820px}
    thead th{position:sticky; top:0; background:color-mix(in srgb, var(--card) 90%, transparent); backdrop-filter:blur(6px); font-size:12px; color:var(--muted); text-align:left; padding:10px; border-bottom:1px solid var(--border)}
    tbody td{padding:12px 10px; border-bottom:1px solid var(--border); vertical-align:middle}
    tbody tr:hover{background:rgba(0,0,0,.03)}
    .rank{width:56px; text-align:right; font-variant-numeric:tabular-nums}
    .coin{display:flex; align-items:center; gap:10px}
    .coin img{width:28px; height:28px; border-radius:50%; box-shadow:0 0 0 1px var(--border); background:#fff; object-fit:cover}
    .sym{color:var(--muted); font-size:12px}
    .num{font-variant-numeric:tabular-nums}
    .chg.up{color:var(--ok)} .chg.down{color:var(--down)}
    .spark{width:120px; height:36px}
    .actions{display:flex; gap:8px}
    .btn{display:inline-flex; align-items:center; gap:6px; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#0b1220; color:#e5e7eb; font-weight:700; cursor:pointer; touch-action:manipulation}
    .btn.primary{background:var(--brand); color:#fff; border-color:transparent}

    /* Mobile Cards */
    .cards{display:none}
    @media (max-width:768px){
      .table{display:none}
      .cards{display:grid; gap:12px}
      .item{display:flex; flex-direction:column; gap:8px; background:var(--card); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:12px}
      .row1{display:flex; align-items:center; gap:10px; justify-content:space-between}
      .left{display:flex; align-items:center; gap:10px; min-width:0}
      .rank-badge{font-variant-numeric:tabular-nums; font-weight:800; width:28px; text-align:right}
      .coin img{width:26px; height:26px}
      .name{font-weight:800; max-width:44vw; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
      .sym{font-size:12px}
      .price{font-weight:900}
      .row2{display:grid; grid-template-columns: repeat(4, auto); gap:10px; align-items:center; font-size:13px}
      .kv{display:flex; flex-direction:column; gap:2px}
      .kv .k{color:var(--muted); font-size:12px}
      .spark{width:100%; height:34px}
      .actions{margin-top:6px}
      @media (max-width:420px){
        .row2{grid-template-columns: repeat(2, 1fr)}
        .spark{display:none}
      }
    }

    /* ModalsÔºàÂê´KÁ∫øÔºâ */
    .modal{position:fixed; inset:0; background:rgba(0,0,0,.45); display:flex; align-items:center; justify-content:center; padding:22px}
    .hidden{display:none}
    .modal-card{width:min(920px,100%); background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:0 30px 80px rgba(0,0,0,.35); overflow:hidden}
    .modal-head{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--border)}
    .modal-body{padding:12px}
    .form{display:grid; gap:10px}
    label{font-size:13px; color:var(--muted)}
    input, select{width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:transparent; color:inherit}
    input:focus, select:focus{outline:none; box-shadow:var(--focus)}
    .k-toolbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px}
    .seg{display:flex; gap:4px; background:var(--chip); padding:4px; border-radius:999px}
    .seg button{border:0; padding:8px 10px; border-radius:999px; background:transparent; cursor:pointer; font-weight:700; color:var(--muted)}
    .seg button.is-active{background:#0f172a; color:#fff}
    .k-wrap{position:relative; background:#fff0; border:1px solid var(--border); border-radius:12px; overflow:hidden}
    .k-canvas{width:100%; height:420px; display:block; background:linear-gradient(180deg, rgba(0,0,0,.02), transparent)}
    .k-tooltip{position:absolute; pointer-events:none; background:rgba(17,24,39,.9); color:#fff; font-size:12px; padding:8px 10px; border-radius:8px; transform:translate(8px,8px)}
    .k-legend{display:flex; gap:14px; align-items:center; font-size:12px; color:var(--muted); margin-top:6px}
    footer{color:#94a3b8; font-size:12px; text-align:center; margin:18px 0}
  </style>
</head>
<body>
  <!-- Header -->
  <header class="app-header">
    <div class="container toolbar" role="navigation" aria-label="Top Navigation">
      <div class="brand">
        <span class="badge" aria-hidden="true">‚Çø</span>
        <span id="i-brand">Âä†ÂØÜÂ∏ÇÂú∫ Top 100</span>
      </div>

      <div class="search" role="search">
        <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M15.5 14h-.79l-.28-.27a6.471 6.471 0 0 0 1.57-4.23A6.5 6.5 0 1 0 9.5 16a6.471 6.471 0 0 0 4.23-1.57l.27.28v.79l 4.25 4.25c.41.41 1.08.41 1.49 0s.41-1.08 0-1.49L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
        <input id="searchInput" type="search" placeholder="ÊêúÁ¥¢Â∏ÅÁßç / Search‚Ä¶" aria-label="Search coins" inputmode="search" />
        <button id="clearSearch" class="icon-btn" title="Clear" aria-label="Clear search">‚úï</button>
      </div>

      <div class="actions-bar" style="display:flex; align-items:center; gap:10px">
        <div class="chip-group" id="langSwitch" role="tablist" aria-label="Language">
          <button class="chip is-active" role="tab" data-lang="zh">‰∏≠Êñá</button>
          <button class="chip" role="tab" data-lang="en">EN</button>
        </div>
        <a href="/affiliate/index.html" class="btn" title="ÈÇÄËØ∑ËøîÂà© / Affiliates">ü§ù ÈÇÄËØ∑ËøîÂà©</a>
        <button id="walletBtn" class="btn primary">üëú <span id="i-connect">ËøûÊé•Èí±ÂåÖ</span></button>
        <button id="settingsBtn" class="btn" title="API Key & ËÆæÁΩÆ">‚öôÔ∏è</button>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <div class="container">
    <section class="hero">
      <div class="panel">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap">
          <h2 style="margin:0" id="i-marketOverview">Â∏ÇÂú∫Ê¶ÇËßà</h2>
          <div class="actions" style="display:flex; gap:8px; flex-wrap:wrap">
            <button class="btn" id="refreshBtn">‚ü≤ <span id="i-refresh">Âà∑Êñ∞</span></button>
            <div class="chip-group" id="sortSwitch" aria-label="Sort">
              <button class="chip is-active" data-sort="mcap">MC</button>
              <button class="chip" data-sort="price">Price</button>
              <button class="chip" data-sort="change24h">24h</button>
            </div>
          </div>
        </div>
        <div class="stats" style="margin-top:10px">
          <div class="stat"><div class="k" id="i-gcap">ÂÖ®ÁêÉÊÄªÂ∏ÇÂÄº</div><div class="v" id="gcap">‚Äî</div></div>
          <div class="stat"><div class="k" id="i-gdelta">24Â∞èÊó∂ÂèòÂä®</div><div class="v delta" id="gdelta">‚Äî</div></div>
          <div class="stat"><div class="k" id="i-btcdom">BTC Âç†ÊØî</div><div class="v" id="btcdom">‚Äî</div></div>
        </div>
      </div>
      <div class="panel">
        <div class="stat">
          <div class="k" id="i-apiKeyLabel">CoinGecko API Key</div>
          <div class="v" id="apiKeyState">Êú™ËÆæÁΩÆ</div>
        </div>
        <p class="helper" id="i-apiHelp">‰ΩøÁî®ÂÖ¨ÂºÄ Demo Key ‰πüÂèØ‰ª•Ôºà‰ªÖÈôêÈÄü‰∏çÂêåÔºâ„ÄÇÊú™ËÆæÁΩÆÊó∂‰ªçÂèØÂ∞ùËØïÂõûÈÄÄÊï∞ÊçÆ„ÄÇ</p>
        <div class="actions">
          <button class="btn" id="openKey" style="width:100%">üîë <span id="i-openKey">ËÆæÁΩÆ / Êõ¥Êç¢ Key</span></button>
        </div>
      </div>
    </section>

    <!-- Desktop Table -->
    <section class="table" aria-label="Top 100 cryptocurrencies (table)">
      <table>
        <thead>
          <tr>
            <th class="rank">#</th>
            <th id="i-col-coin">Â∏ÅÁßç</th>
            <th id="i-col-price">‰ª∑Ê†º(USD)</th>
            <th id="i-col-mcap">Â∏ÇÂÄº</th>
            <th id="i-col-24h">24h</th>
            <th id="i-col-7d">7d</th>
            <th id="i-col-vol">Êàê‰∫§È¢ù(24h)</th>
            <th id="i-col-act">Êìç‰Ωú</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>

    <!-- Mobile Cards -->
    <section class="cards" aria-label="Top 100 cryptocurrencies (cards)">
      <div id="cardList" role="list"></div>
    </section>

    <footer id="i-disclaimer">
      * ‰∏ªÊï∞ÊçÆÊ∫êÔºöCoinGeckoÔºàÈúÄ API KeyÔºõDemo ËÆ°ÂàíÁî® `x-cg-demo-api-key` Êàñ `x_cg_demo_api_key`Ôºâ„ÄÇÂ§±Ë¥•Êó∂ÈÄÄÂåñÂà∞ CoinCap Âü∫Á°ÄÊï∞ÊçÆ/ÂõæÊ†á„ÄÇÁîü‰∫ßÂª∫ËÆÆÂ∞Ü Key ÊîæÂà∞ÂêéÁ´Ø‰ª£ÁêÜ„ÄÇ
    </footer>
  </div>

  <!-- Wallet ModalÔºà‰øùÁïôÔºâ -->
  <div id="walletModal" class="modal hidden" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="walletTitle">
      <div class="modal-head">
        <h3 id="walletTitle">ËøûÊé•Èí±ÂåÖ</h3>
        <button class="icon-btn" id="walletClose" aria-label="Close">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="form">
          <div>
            <label id="i-walletDetected">Ê£ÄÊµãÂà∞ÁöÑÈí±ÂåÖ</label>
            <div id="walletDetectResult" class="helper">‚Äî</div>
          </div>
          <div>
            <button class="btn primary" id="btnMetaMask">ü¶ä <span id="i-useMetaMask">‰ΩøÁî® MetaMask</span></button>
          </div>
          <div>
            <button class="btn" id="btnMock">üéõÔ∏è <span id="i-useMock">‰ΩøÁî®Ê®°ÊãüÂú∞ÂùÄ</span></button>
            <div class="helper" id="i-mockNote">Áî®‰∫éËÅîË∞ÉÁöÑÂç†‰ΩçÊñπÊ°àÔºå‰∏ç‰ºö‰∫ßÁîüÁúüÂÆûÈìæ‰∏ä‰∫§‰∫í„ÄÇ</div>
          </div>
          <div>
            <label id="i-walletAddr">ÂΩìÂâçÂú∞ÂùÄ</label>
            <input id="currentAddr" readonly placeholder="0x‚Ä¶"/>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings ModalÔºà‰øùÁïôÔºâ -->
  <div id="settingsModal" class="modal hidden" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
      <div class="modal-head">
        <h3 id="settingsTitle">ËÆæÁΩÆ</h3>
        <button class="icon-btn" id="settingsClose" aria-label="Close">‚úï</button>
      </div>
      <div class="modal-body">
        <form id="settingsForm" class="form" novalidate>
          <div>
            <label for="apiKeyInput">CoinGecko API Key</label>
            <input id="apiKeyInput" placeholder="Á≤òË¥¥‰Ω†ÁöÑ x-cg-demo-api-key" />
            <div class="helper" id="i-keyHelper">Âª∫ËÆÆÁî®ËØ∑Ê±ÇÂ§¥ÊñπÂºèÔºàÊõ¥ÂÆâÂÖ®ÔºâÔºõ‰πüÊîØÊåÅ query ÂèÇÊï∞„ÄÇ‰ªÖÂÅöÊºîÁ§∫Â≠òÂÇ®Âú®Êú¨Âú∞„ÄÇ</div>
          </div>
          <div>
            <label for="localeSelect" id="i-langLabel">ÁïåÈù¢ËØ≠Ë®Ä</label>
            <select id="localeSelect">
              <option value="zh">‰∏≠Êñá</option>
              <option value="en">English</option>
            </select>
          </div>
          <div class="actions" style="justify-content:flex-end">
            <button type="button" class="btn" id="btnClearKey">Ê∏ÖÈô§ Key</button>
            <button type="submit" class="btn primary" id="btnSaveSettings">‰øùÂ≠ò</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- K-line Modal -->
  <div id="kModal" class="modal hidden" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="kTitle">
      <div class="modal-head">
        <h3 id="kTitle">KÁ∫ø</h3>
        <button class="icon-btn" id="kClose" aria-label="Close">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="k-toolbar">
          <div class="seg" id="tfSeg">
            <button data-d="1"  class="is-active">1D</button>
            <button data-d="7">7D</button>
            <button data-d="30">30D</button>
            <button data-d="90">90D</button>
            <button data-d="180">180D</button>
            <button data-d="365">365D</button>
            <button data-d="max">MAX</button>
          </div>
          <div class="seg" id="styleSeg">
            <button data-style="solid" class="is-active">ÂÆûÂøÉ</button>
            <button data-style="hollow">Á©∫ÂøÉ</button>
          </div>
          <div class="seg" id="schemeSeg">
            <button data-s="us" class="is-active">ÁªøÊ∂®Á∫¢Ë∑å</button>
            <button data-s="cn">Á∫¢Ê∂®ÁªøË∑å</button>
          </div>
        </div>

        <div class="k-wrap">
          <canvas id="kCanvas" class="k-canvas"></canvas>
          <div id="kTip" class="k-tooltip hidden"></div>
        </div>
        <div class="k-legend" id="kLegend">‚Äî</div>
      </div>
    </div>
  </div>

  <!-- Row & Card templatesÔºàÁï•‰øùÁïôÔºâ -->
  <template id="row">
    <tr>
      <td class="rank num">1</td>
      <td>
        <div class="coin">
          <img alt="logo" loading="lazy" referrerpolicy="no-referrer" />
          <div>
            <div class="name">Bitcoin</div>
            <div class="sym">BTC</div>
          </div>
        </div>
      </td>
      <td class="num price">$‚Äî</td>
      <td class="num mcap">$‚Äî</td>
      <td class="num chg chg24">‚Äî</td>
      <td>
        <svg class="spark" viewBox="0 0 120 36" preserveAspectRatio="none" aria-hidden="true"></svg>
        <div class="num chg chg7" style="font-size:12px; margin-top:2px">‚Äî</div>
      </td>
      <td class="num vol">$‚Äî</td>
      <td>
        <div class="actions">
          <a class="btn" target="_blank" rel="noopener" data-role="open">üîé <span class="i-open">ËØ¶ÊÉÖ</span></a>
          <button class="btn" data-role="kline">üìà KÁ∫ø</button>
        </div>
      </td>
    </tr>
  </template>

  <template id="cardItem">
    <article class="item" role="listitem">
      <div class="row1">
        <div class="left">
          <div class="rank-badge">#<span class="rank">1</span></div>
          <div class="coin">
            <img alt="logo" loading="lazy" referrerpolicy="no-referrer" />
            <div>
              <div class="name">Bitcoin</div>
              <div class="sym">BTC</div>
            </div>
          </div>
        </div>
        <div class="price">$‚Äî</div>
      </div>
      <div class="row2">
        <div class="kv"><div class="k">24h</div><div class="v chg chg24">‚Äî</div></div>
        <div class="kv"><div class="k">7d</div><div class="v chg chg7">‚Äî</div></div>
        <div class="kv"><div class="k">MCap</div><div class="v mcap">$‚Äî</div></div>
        <div class="kv"><div class="k">Vol</div><div class="v vol">$‚Äî</div></div>
      </div>
      <svg class="spark" viewBox="0 0 120 36" preserveAspectRatio="none" aria-hidden="true"></svg>
      <div class="actions">
        <a class="btn" target="_blank" rel="noopener" data-role="open">üîé <span class="i-open">ËØ¶ÊÉÖ</span></a>
        <button class="btn" data-role="kline">üìà KÁ∫ø</button>
      </div>
    </article>
  </template>

  <script>
  ;(() => {
    /* ========= i18n / stateÔºà‰∏é‰πãÂâçÁâàÊú¨‰∏ÄËá¥ÔºåÁï•Ôºâ ========= */
    const i18n = {
      zh:{ brand:"Âä†ÂØÜÂ∏ÇÂú∫ Top 100",search_placeholder:"ÊêúÁ¥¢Â∏ÅÁßç / Search‚Ä¶",marketOverview:"Â∏ÇÂú∫Ê¶ÇËßà",refresh:"Âà∑Êñ∞",
           gcap:"ÂÖ®ÁêÉÊÄªÂ∏ÇÂÄº",gdelta:"24Â∞èÊó∂ÂèòÂä®",btcdom:"BTC Âç†ÊØî",
           apiKeyLabel:"CoinGecko API Key",apiHelp:"‰ΩøÁî®ÂÖ¨ÂºÄ Demo Key ‰πüÂèØ‰ª•Ôºà‰ªÖÈôêÈÄü‰∏çÂêåÔºâ„ÄÇÊú™ËÆæÁΩÆÊó∂‰ªçÂèØÂ∞ùËØïÂõûÈÄÄÊï∞ÊçÆ„ÄÇ",openKey:"ËÆæÁΩÆ / Êõ¥Êç¢ Key",
           col:{coin:"Â∏ÅÁßç", price:"‰ª∑Ê†º(USD)", mcap:"Â∏ÇÂÄº", d24:"24h", d7:"7d", vol:"Êàê‰∫§È¢ù(24h)", act:"Êìç‰Ωú"},
           connect:"ËøûÊé•Èí±ÂåÖ", wallet:{title:"ËøûÊé•Èí±ÂåÖ",detected:"Ê£ÄÊµãÂà∞ÁöÑÈí±ÂåÖ",useMM:"‰ΩøÁî® MetaMask",useMock:"‰ΩøÁî®Ê®°ÊãüÂú∞ÂùÄ",mockNote:"Áî®‰∫éËÅîË∞ÉÁöÑÂç†‰ΩçÊñπÊ°àÔºå‰∏ç‰ºö‰∫ßÁîüÁúüÂÆûÈìæ‰∏ä‰∫§‰∫í„ÄÇ", addr:"ÂΩìÂâçÂú∞ÂùÄ"},
           settings:{title:"ËÆæÁΩÆ", keyHelper:"Âª∫ËÆÆÁî®ËØ∑Ê±ÇÂ§¥ÊñπÂºèÔºàÊõ¥ÂÆâÂÖ®ÔºâÔºõ‰πüÊîØÊåÅ query ÂèÇÊï∞„ÄÇ‰ªÖÂÅöÊºîÁ§∫Â≠òÂÇ®Âú®Êú¨Âú∞„ÄÇ", langLabel:"ÁïåÈù¢ËØ≠Ë®Ä", save:"‰øùÂ≠ò", clearKey:"Ê∏ÖÈô§ Key"},
           open:"ËØ¶ÊÉÖ",
           disclaimer:"* ‰∏ªÊï∞ÊçÆÊ∫êÔºöCoinGeckoÔºàÈúÄ API KeyÔºõDemo ËÆ°ÂàíÂèØÁî®Ôºâ„ÄÇÂ§±Ë¥•Êó∂ÈÄÄÂåñÂà∞ CoinCap„ÄÇÁîü‰∫ßÂª∫ËÆÆÂ∞Ü Key ÁΩÆ‰∫éÂêéÁ´Ø„ÄÇ"
      },
      en:{ brand:"Crypto Market Top 100",search_placeholder:"Search coins‚Ä¶",marketOverview:"Market Overview",refresh:"Refresh",
           gcap:"Global Mkt Cap",gdelta:"24h Change",btcdom:"BTC Dominance",
           apiKeyLabel:"CoinGecko API Key",apiHelp:"Demo key works too (lower rate limit). Fallback data is attempted.",openKey:"Set / Change Key",
           col:{coin:"Coin", price:"Price(USD)", mcap:"Mkt Cap", d24:"24h", d7:"7d", vol:"Volume(24h)", act:"Action"},
           connect:"Connect Wallet", wallet:{title:"Connect Wallet",detected:"Detected Wallets",useMM:"Use MetaMask",useMock:"Use Mock Address",mockNote:"For dev only. No real on‚Äëchain tx.", addr:"Current Address"},
           settings:{title:"Settings", keyHelper:"Header usage recommended; query also supported. Saved locally for demo.", langLabel:"Language", save:"Save", clearKey:"Clear Key"},
           open:"Details",
           disclaimer:"* Primary source: CoinGecko (API key required). Falls back to CoinCap. In production, proxy keys via backend."
      }
    }
    const state = {
      lang: localStorage.getItem('lang') || 'zh',
      sort: 'mcap',
      apiKey: localStorage.getItem('cg_api_key') || '',
      cacheTTL: 60_000, globalTTL: 10*60_000,
      wallet: localStorage.getItem('wallet_addr') || '',
      kStyle: localStorage.getItem('k_style') || 'solid',   // 'solid' | 'hollow'
      kScheme: localStorage.getItem('k_scheme') || 'us',    // 'us' | 'cn'
      refChain: [] // ËÆøÈóÆÊó∂Ëß£Êûê ?ref= ÂΩ¢ÊàêÊúÄÂ§ö 2 Á∫ßÈìæ
    };
    const t = (path) => path.split('.').reduce((o,k)=>o?.[k], i18n[state.lang]) ?? path;
    document.documentElement.lang = state.lang;

      /* ========= Referral captureÔºàË∑®È°µËÆ∞ÂΩïÊúÄÂ§ö2Á∫ßÔºâ ========= */
    (function captureRef(){
      const url = new URL(location.href); const ref = url.searchParams.get('ref');
      try{
        const chain = JSON.parse(localStorage.getItem('ref_chain') || '[]');
        if(ref && typeof ref === 'string'){
          // ÂéªÈáçÂπ∂ÊúÄÂ§ö2Á∫ß
          const set = new Set([ref, ...chain]);
          const arr = Array.from(set).slice(0,2);
          localStorage.setItem('ref_chain', JSON.stringify(arr));
        }
        state.refChain = JSON.parse(localStorage.getItem('ref_chain') || '[]');
      }catch{ state.refChain = []; }
    })();

    /* ========= DOM refs ========= */
    const $ = s => document.querySelector(s);
    const els = {
      brand: $('#i-brand'), search: $('#searchInput'), clear: $('#clearSearch'),
      langSwitch: $('#langSwitch'), sortSwitch: $('#sortSwitch'), refresh: $('#refreshBtn'),
      tbody: $('#tbody'), cardList: $('#cardList'),
      gcap: $('#gcap'), gdelta: $('#gdelta'), btcdom: $('#btcdom'),
      apiKeyState: $('#apiKeyState'), openKey: $('#openKey'),
      settingsBtn: $('#settingsBtn'), settingsModal: $('#settingsModal'), settingsClose: $('#settingsClose'),
      settingsForm: $('#settingsForm'), apiKeyInput: $('#apiKeyInput'), localeSelect: $('#localeSelect'),
      btnClearKey: $('#btnClearKey'), btnSaveSettings: $('#btnSaveSettings'),
      walletBtn: $('#walletBtn'), walletModal: $('#walletModal'), walletClose: $('#walletClose'),
      btnMetaMask: $('#btnMetaMask'), btnMock: $('#btnMock'), walletDetected: $('#walletDetectResult'), currAddr: $('#currentAddr'),

      // K-line
      kModal: $('#kModal'), kClose: $('#kClose'),
      kCanvas: $('#kCanvas'), kTip: $('#kTip'), kLegend: $('#kLegend'),
      tfSeg: $('#tfSeg'), styleSeg: $('#styleSeg'), schemeSeg: $('#schemeSeg')
    };

    /* ========= Utils ========= */
    const locale = () => state.lang === 'zh' ? 'zh-CN' : 'en-US';
    const nf = (opts) => new Intl.NumberFormat(locale(), opts);
    const fmtUSD = v => (v==null? '‚Äî' : nf({style:'currency', currency:'USD', maximumFractionDigits: v>100?0: v>1?2: 6}).format(v));
    const fmtPct = v => (v==null? '‚Äî' : (v>=0? '+' : '') + nf({maximumFractionDigits:2}).format(v) + '%');
    const shortNum = n => {
      if(n==null) return '‚Äî';
      const abs = Math.abs(n);
      const units = [{k:1e12,s:'T'},{k:1e9,s:'B'},{k:1e6,s:'M'},{k:1e3,s:'K'}];
      for(const u of units){ if(abs>=u.k) return (n/u.k).toFixed(abs>=10*u.k?1:2)+u.s; }
      return nf({maximumFractionDigits:0}).format(n);
    };

    /* ========= Fetch layer ========= */
    const withHeaders = (init={}) => {
      const headers = new Headers(init.headers || {});
      headers.set('accept','application/json');
      if(state.apiKey) headers.set('x-cg-demo-api-key', state.apiKey); // Demo Plan header
      return {...init, headers};
    };
    const cacheGet = (k, ttl) => { try{
      const it = JSON.parse(localStorage.getItem(k) || 'null'); if(!it) return null;
      if(Date.now() - it.ts > ttl) return null; return it.data;
    }catch{ return null; } };
    const cacheSet = (k, data) => localStorage.setItem(k, JSON.stringify({ts:Date.now(), data}));

    async function getMarkets(){
      const CK = 'cg:markets'; const cached = cacheGet(CK, state.cacheTTL); if(cached) return cached;
      const qs = new URLSearchParams({ vs_currency:'usd', order:'market_cap_desc', per_page:'100', page:'1',
        sparkline:'true', price_change_percentage:'24h,7d' });
      if(state.apiKey) qs.set('x_cg_demo_api_key', state.apiKey);
      const url = `https://api.coingecko.com/api/v3/coins/markets?`+qs.toString();
      try{
        const res = await fetch(url, withHeaders()); if(!res.ok) throw new Error('coingecko '+res.status);
        const data = await res.json(); cacheSet(CK, data); return data;
      }catch(e){ console.warn('[fallback] markets failed', e); return await getMarketsFallback(); }
    }
    async function getGlobal(){
      const CK = 'cg:global'; const cached = cacheGet(CK, state.globalTTL); if(cached) return cached;
      const qs = new URLSearchParams(); if(state.apiKey) qs.set('x_cg_demo_api_key', state.apiKey);
      try{
        const res = await fetch(`https://api.coingecko.com/api/v3/global?${qs}`, withHeaders());
        if(!res.ok) throw new Error('coingecko-global '+res.status);
        const data = await res.json(); cacheSet(CK, data); return data;
      }catch(e){ console.warn('[fallback] global failed', e); return null; }
    }
    // OHLCÔºà‰ºòÂÖàÔºâ
    async function getOHLC(coinId, days){
      const qs = new URLSearchParams({ vs_currency:'usd', days:String(days) });
      if(state.apiKey) qs.set('x_cg_demo_api_key', state.apiKey);
      const url = `https://api.coingecko.com/api/v3/coins/${coinId}/ohlc?`+qs.toString(); // [t,o,h,l,c]
      const res = await fetch(url, withHeaders());
      if(!res.ok) throw new Error('ohlc '+res.status);
      const arr = await res.json();
      return arr.map(([t,o,h,l,c]) => ({ t, o, h, l, c }));
    }
    // Â§áÁî®ÔºöÁî® market_chart ÁöÑ prices ËÅöÂêàÊàê OHLC
    async function getOHLCFromPrices(coinId, days){
      const qs = new URLSearchParams({ vs_currency:'usd', days:String(days) });
      if(state.apiKey) qs.set('x_cg_demo_api_key', state.apiKey);
      const url = `https://api.coingecko.com/api/v3/coins/${coinId}/market_chart?`+qs.toString(); // {prices:[[t,p],...]}
      const res = await fetch(url, withHeaders()); if(!res.ok) throw new Error('chart '+res.status);
      const data = await res.json(); const prices = data.prices || [];
      if(!prices.length) return [];
      const t0 = prices[0][0], t1 = prices[prices.length-1][0];
      const bins = Math.min(180, Math.max(30, Math.floor(prices.length / 10)));
      const bucket = (t1 - t0) / bins;
      const out = [];
      for(let b=0;b<bins;b++){
        const start = t0 + b*bucket, end = start + bucket;
        const pts = prices.filter(([t]) => t>=start && t<end);
        if(!pts.length) continue;
        const o = pts[0][1], c = pts[pts.length-1][1];
        let h = -Infinity, l = Infinity;
        for(const [,p] of pts){ if(p>h) h=p; if(p<l) l=p; }
        out.push({ t: Math.round((start+end)/2), o, h, l, c });
      }
      return out;
    }
    // Fallback marketsÔºàCoinCapÂü∫Á°ÄÔºâ
    async function getMarketsFallback(){
      try{
        const res = await fetch('https://api.coincap.io/v2/assets?limit=100');
        if(!res.ok) throw new Error('coincap '+res.status);
        const { data } = await res.json();
        return data.map((it, i) => ({
          market_cap_rank: i+1,
          id: it.id, symbol: it.symbol?.toLowerCase(), name: it.name,
          image: `https://assets.coincap.io/assets/icons/${(it.symbol||'').toLowerCase()}@2x.png`,
          current_price: Number(it.priceUsd),
          market_cap: Number(it.marketCapUsd),
          total_volume: Number(it.volumeUsd24Hr),
          price_change_percentage_24h: Number(it.changePercent24Hr),
          sparkline_in_7d: { price: [] },
          price_change_percentage_7d_in_currency: null
        }));
      }catch(err){ console.error('Fallback failed:', err); return []; }
    }

    /* ========= UIÊñáÊú¨Ê∏≤ÊüìÔºàÁï•‰øùÁïôÔºâ ========= */
    function applyTexts(){
      $('#i-brand').textContent = t('brand'); $('#searchInput').placeholder = t('search_placeholder');
      $('#i-marketOverview').textContent = t('marketOverview'); $('#i-refresh').textContent = t('refresh');
      $('#i-gcap').textContent = t('gcap'); $('#i-gdelta').textContent = t('gdelta'); $('#i-btcdom').textContent = t('btcdom');
      $('#i-apiKeyLabel').textContent = t('apiKeyLabel'); $('#i-apiHelp').textContent = t('apiHelp'); $('#i-openKey').textContent = t('openKey');
      $('#i-col-coin').textContent = t('col.coin'); $('#i-col-price').textContent = t('col.price');
      $('#i-col-mcap').textContent = t('col.mcap'); $('#i-col-24h').textContent = t('col.d24');
      $('#i-col-7d').textContent = t('col.d7'); $('#i-col-vol').textContent = t('col.vol'); $('#i-col-act').textContent = t('col.act');
      document.querySelectorAll('.i-open').forEach(n=>n.textContent = t('open'));
      document.querySelector('#i-disclaimer').textContent = t('disclaimer');
      document.documentElement.lang = state.lang;
    }
    function renderGlobal(glob){
      if(!glob?.data){ els.gcap.textContent='‚Äî'; els.gdelta.textContent='‚Äî'; els.btcdom.textContent='‚Äî'; return; }
      const d = glob.data; const cap = d.total_market_cap?.usd; const delta = d.market_cap_change_percentage_24h_usd; const btc = d.market_cap_percentage?.btc;
      els.gcap.textContent = fmtUSD(cap); els.gdelta.textContent = fmtPct(delta); els.gdelta.className = 'v delta ' + (delta>=0?'up':'down');
      els.btcdom.textContent = (btc!=null? nf({maximumFractionDigits:2}).format(btc)+'%' : '‚Äî');
    }

    /* ========= SparklineÔºà‰øùÁïôÔºâ ========= */
    function drawSpark(svg, prices){
      const w = 120, h = 36, pad=2; svg.setAttribute('viewBox',`0 0 ${w} ${h}`); svg.innerHTML = ''; if(!prices || prices.length<2) return;
      const min = Math.min(...prices), max = Math.max(...prices);
      const xs = prices.map((_,i)=> pad + (i*(w-2*pad)/(prices.length-1)));
      const ys = prices.map(v => max===min? h/2 : pad + (h-2*pad) - ((v-min)/(max-min)*(h-2*pad)));
      const d = xs.map((x,i)=> `${i?'L':'M'}${x.toFixed(2)},${ys[i].toFixed(2)}`).join(' ');
      const path = document.createElementNS('http://www.w3.org/2000/svg','path');
      path.setAttribute('d', d); path.setAttribute('fill','none'); path.setAttribute('stroke','currentColor'); path.setAttribute('stroke-width','1.5');
      svg.appendChild(path);
    }

    /* ========= ÂàóË°®Ê∏≤Êüì ========= */
    function bySearch(kw){ if(!kw) return ()=>true; kw=kw.trim().toLowerCase(); return p => (p.name?.toLowerCase().includes(kw) || p.symbol?.toLowerCase().includes(kw)); }
    const sorters = { mcap:(a,b)=>(b.market_cap??0)-(a.market_cap??0), price:(a,b)=>(b.current_price??0)-(a.current_price??0), change24h:(a,b)=>(b.price_change_percentage_24h??-1e9)-(a.price_change_percentage_24h??-1e9) };

    function renderTableRows(data){
      els.tbody.innerHTML = '';
      const tpl = document.getElementById('row'); const frag = document.createDocumentFragment();
      data.forEach((p,idx)=>{
        const node = tpl.content.cloneNode(true);
        node.querySelector('.rank').textContent = p.market_cap_rank ?? (idx+1);
        const img = node.querySelector('img');
        img.src = p.image || `https://assets.coincap.io/assets/icons/${(p.symbol||'').toLowerCase()}@2x.png`;
        img.alt = `${p.name} logo`;
        img.onerror = () => { img.onerror=null; img.src=`https://assets.coincap.io/assets/icons/${(p.symbol||'').toLowerCase()}@2x.png`; };
        node.querySelector('.name').textContent = p.name; node.querySelector('.sym').textContent = (p.symbol || '').toUpperCase();
        node.querySelector('.price').textContent = fmtUSD(p.current_price);
        node.querySelector('.mcap').textContent = '$'+ shortNum(p.market_cap);
        const c24 = p.price_change_percentage_24h; const el24 = node.querySelector('.chg24'); el24.textContent = fmtPct(c24); el24.classList.add(c24>=0?'up':'down');
        const c7 = p.price_change_percentage_7d_in_currency ?? p.price_change_percentage_7d ?? null;
        const el7 = node.querySelector('.chg7'); el7.textContent = c7==null? '‚Äî' : fmtPct(c7); el7.classList.add(c7>=0?'up':'down');
        drawSpark(node.querySelector('.spark'), p.sparkline_in_7d?.price);
        node.querySelector('.vol').textContent = '$'+ shortNum(p.total_volume);
        const loc = state.lang==='zh' ? 'zh' : 'en';
        node.querySelector('[data-role="open"]').href = `https://www.coingecko.com/${loc}/coins/${p.id}`;
        // KÁ∫øÊåâÈíÆ
        node.querySelector('[data-role="kline"]').addEventListener('click', ()=> openKModal(p));
        frag.appendChild(node);
      });
      els.tbody.appendChild(frag);
    }

    function renderCards(data){
      els.cardList.innerHTML = '';
      const tpl = document.getElementById('cardItem'); const frag = document.createDocumentFragment();
      data.forEach((p,idx)=>{
        const node = tpl.content.cloneNode(true);
        node.querySelector('.rank').textContent = p.market_cap_rank ?? (idx+1);
        const img = node.querySelector('img');
        img.src = p.image || `https://assets.coincap.io/assets/icons/${(p.symbol||'').toLowerCase()}@2x.png`;
        img.alt = `${p.name} logo`;
        img.onerror = () => { img.onerror=null; img.src=`https://assets.coincap.io/assets/icons/${(p.symbol||'').toLowerCase()}@2x.png`; };
        node.querySelector('.name').textContent = p.name; node.querySelector('.sym').textContent = (p.symbol || '').toUpperCase();
        node.querySelector('.price').textContent = fmtUSD(p.current_price);
        const c24 = p.price_change_percentage_24h; const el24 = node.querySelector('.chg24'); el24.textContent = fmtPct(c24); el24.classList.add(c24>=0?'up':'down');
        const c7 = p.price_change_percentage_7d_in_currency ?? p.price_change_percentage_7d ?? null;
        node.querySelector('.chg7').textContent = c7==null? '‚Äî' : fmtPct(c7);
        node.querySelector('.mcap').textContent = '$'+ shortNum(p.market_cap);
        node.querySelector('.vol').textContent = '$'+ shortNum(p.total_volume);
        drawSpark(node.querySelector('.spark'), p.sparkline_in_7d?.price);
        const loc = state.lang==='zh' ? 'zh' : 'en';
        node.querySelector('[data-role="open"]').href = `https://www.coingecko.com/${loc}/coins/${p.id}`;
        node.querySelector('[data-role="kline"]').addEventListener('click', ()=> openKModal(p));
        frag.appendChild(node);
      });
      els.cardList.appendChild(frag);
    }

    /* ========= WalletÔºà‰øùÁïôÔºâ ========= */
    function updateWalletUI(){
      const label = state.wallet ? (state.wallet.slice(0,6)+'‚Ä¶'+state.wallet.slice(-4)) : t('connect');
      els.walletBtn.querySelector('span').textContent = label; els.currAddr.value = state.wallet || '';
    }
    async function tryMetaMask(){
      const eth = window.ethereum; if(!eth){ alert(state.lang==='zh'?'Êú™Ê£ÄÊµãÂà∞ MetaMask Êàñ EIP‚Äë1193 Èí±ÂåÖ„ÄÇ':'No MetaMask / EIP‚Äë1193 wallet detected.'); return; }
      try{
        const accts = await eth.request({ method:'eth_requestAccounts' });
        const addr = (accts && accts[0]) || '';
        if(addr){
          state.wallet = addr; localStorage.setItem('wallet_addr', addr);
          updateWalletUI(); closeWallet();
          // È¢ÑÁïôÂêéÁ´ØÔºöfetch('/api/wallet/connect', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ address: addr, ts: Date.now() })})
        }
      }catch(err){ console.warn('MetaMask rejected/failed', err); }
    }
    function mockAddress(){
      const hex = Array.from(crypto.getRandomValues(new Uint8Array(20))).map(b=>b.toString(16).padStart(2,'0')).join('');
      const addr = '0x'+hex; state.wallet = addr; localStorage.setItem('wallet_addr', addr);
      updateWalletUI(); closeWallet();
    }

    /* ========= KÁ∫øÁîªÂ∏É ========= */
    const KOPT = { padL:48, padR:12, padT:20, padB:28, gridY:5, bg:'#0000' };
    function pxRatio(){ return Math.max(1, Math.min(2, window.devicePixelRatio || 1)); }
    function colorSet(){
      // È¢úËâ≤ÊñπÊ°àÔºöus=ÁªøÊ∂®Á∫¢Ë∑åÔºõcn=Á∫¢Ê∂®ÁªøË∑å
      const up = state.kScheme==='us' ? '#16a34a' : '#ef4444';
      const dn = state.kScheme==='us' ? '#ef4444' : '#16a34a';
      return { up, dn, wick:'#64748b', axis:'#94a3b8' };
    }
    function drawK(canvas, data){
      const pr = pxRatio();
      const ctx = canvas.getContext('2d'); const W = canvas.clientWidth, H = canvas.clientHeight;
      canvas.width = Math.floor(W*pr); canvas.height = Math.floor(H*pr); ctx.setTransform(pr,0,0,pr,0,0);
      ctx.clearRect(0,0,W,H); ctx.fillStyle='transparent'; ctx.fillRect(0,0,W,H);
      if(!data?.length){ ctx.fillStyle='#94a3b8'; ctx.fillText('No OHLC data', 10, 20); return; }

      const {padL,padR,padT,padB,gridY} = KOPT; const iw = W - padL - padR; const ih = H - padT - padB;
      // y Â∞∫Â∫¶
      let min = Infinity, max = -Infinity;
      data.forEach(d=>{ if(d.l<min) min=d.l; if(d.h>max) max=d.h; });
      if(!(max>min)){ max = min + 1; }
      const y = (v)=> padT + (ih - (v - min)/(max - min) * ih);

      // ÁΩëÊ†º & ËΩ¥
      ctx.strokeStyle = '#e5e7eb20'; ctx.lineWidth = 1;
      for(let i=0;i<=gridY;i++){
        const yy = padT + i*(ih/gridY);
        ctx.beginPath(); ctx.moveTo(padL, yy); ctx.lineTo(W - padR, yy); ctx.stroke();
        // ‰ª∑Ê†ºÂàªÂ∫¶
        const val = max - i*(max-min)/gridY; ctx.fillStyle=colorSet().axis; ctx.font='12px system-ui';
        ctx.fillText(val.toFixed(val>100?0: val>1?2: 6), 4, yy+4);
      }

      // ËÆ°ÁÆóËú°ÁÉõÂÆΩ
      const n = data.length; const cgap = 2; const cW = Math.max(3, Math.min(18, Math.floor(iw / n) - cgap));
      // x Êò†Â∞Ñ
      const xAt = (i)=> padL + i*(cW+cgap) + Math.floor((cW)/2);

      // ÁªòÂà∂
      const {up, dn, wick} = colorSet();
      ctx.lineWidth = 1;

      for(let i=0;i<n;i++){
        const d = data[i];
        const x = xAt(i);
        const yH = y(d.h), yL = y(d.l), yO = y(d.o), yC = y(d.c);
        const upCandle = d.c >= d.o;
        const bodyTop = Math.min(yO,yC), bodyH = Math.max(1, Math.abs(yC - yO));
        // wick
        ctx.strokeStyle = wick; ctx.beginPath(); ctx.moveTo(x, yH); ctx.lineTo(x, yL); ctx.stroke();
        // body
        const col = upCandle ? up : dn;
        ctx.strokeStyle = col; ctx.fillStyle = col;
        if(state.kStyle==='hollow' && upCandle){
          // Á©∫ÂøÉÔºö‰∏äÊ∂®Áî®ÊèèËæπ
          ctx.strokeRect(x - cW/2, bodyTop, cW, bodyH);
        }else{
          ctx.fillRect(x - cW/2, bodyTop, cW, bodyH);
          if(state.kStyle==='hollow'){ ctx.strokeRect(x - cW/2, bodyTop, cW, bodyH); }
        }
      }

      // Âè≥‰æß‰ª∑ËΩ¥ÂΩìÂâçËåÉÂõ¥ÊèêÁ§∫
      ctx.fillStyle=colorSet().axis; ctx.font='12px system-ui';
      ctx.fillText(`${min.toFixed(2)} ‚Äì ${max.toFixed(2)}`, padL, H-8);
    }

    // Tooltip & ‰∫§‰∫í
    function bindKInteractions(canvas, tip, data){
      const show = (e)=>{
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left; const y = e.clientY - rect.top;
        const {padL,padR} = KOPT; const iw = canvas.clientWidth - padL - padR;
        const n = data.length; if(n<1) return;
        const slot = iw / n; const i = Math.max(0, Math.min(n-1, Math.floor((x - padL) / slot)));
        const d = data[i]; if(!d) return;
        const date = new Date(d.t); const ds = date.toLocaleString();
        tip.classList.remove('hidden');
        tip.style.left = Math.min(canvas.clientWidth - 220, Math.max(0, x + 8))+'px';
        tip.style.top = Math.max(0, y + 8)+'px';
        tip.innerHTML = `Êó∂Èó¥ ${ds}<br>O ${d.o.toFixed(6)}  H ${d.h.toFixed(6)}  L ${d.l.toFixed(6)}  C ${d.c.toFixed(6)}`;
      };
      const hide = ()=> tip.classList.add('hidden');
      canvas.onmousemove = show; canvas.onmouseleave = hide; canvas.ontouchstart = e=>{ show(e.touches[0]); }; canvas.ontouchend = hide;
    }

    // ÊâìÂºÄKÁ∫øÂºπÁ™ó
    let currentCoin = null, currentDays = '1';
    async function openKModal(coin){
      currentCoin = coin; currentDays = '1';
      document.getElementById('kTitle').textContent = `KÁ∫ø ¬∑ ${coin.name} (${coin.symbol?.toUpperCase()})`;
      open(els.kModal); await renderK();
    }
    async function renderK(){
      const id = currentCoin.id; const days = currentDays;
      let ohlc = [];
      try{
        ohlc = await getOHLC(id, days); // ÂÆòÊñπ OHLC Êé•Âè£
      }catch(e){
        console.warn('OHLC failed, fallback to market_chart -> synth candles', e);
        ohlc = await getOHLCFromPrices(id, days); // ÈÄÄÂåñÁî®‰ª∑Ê†ºËÅöÂêà
      }
      drawK(els.kCanvas, ohlc);
      els.kLegend.textContent = `Êï∞ÊçÆÊ∫êÔºö${ohlc.length?'CoinGecko OHLC / ËÅöÂêà':''} ¬∑ Âë®Êúü ${String(days).toUpperCase()}`;
      bindKInteractions(els.kCanvas, els.kTip, ohlc);
    }

    /* ========= Events ========= */
    // Â§öËØ≠Ë®Ä / ÊéíÂ∫è / ÊêúÁ¥¢ / Âà∑Êñ∞Ôºà‰∏é‰πãÂâçÁõ∏ÂêåÔºåÁï•Ôºâ
    els.langSwitch.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-lang]'); if(!btn) return;
      [...els.langSwitch.children].forEach(b=>b.classList.remove('is-active')); btn.classList.add('is-active');
      state.lang = btn.dataset.lang; localStorage.setItem('lang', state.lang);
      applyTexts(); render(true);
    });
    els.sortSwitch.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-sort]'); if(!btn) return;
      [...els.sortSwitch.children].forEach(b=>b.classList.remove('is-active')); btn.classList.add('is-active');
      state.sort = btn.dataset.sort; render();
    });
    $('#searchInput').addEventListener('input', render);
    $('#clearSearch').addEventListener('click', ()=>{ $('#searchInput').value=''; render(); });
    $('#refreshBtn').addEventListener('click', async()=>{ localStorage.removeItem('cg:markets'); await render(true); });

    // Settings
    $('#settingsBtn').addEventListener('click', openSettings); $('#openKey').addEventListener('click', openSettings);
    $('#settingsClose').addEventListener('click', closeSettings);
    $('#settingsForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      state.apiKey = $('#apiKeyInput').value.trim(); localStorage.setItem('cg_api_key', state.apiKey);
      state.lang = $('#localeSelect').value; localStorage.setItem('lang', state.lang);
      els.apiKeyState.textContent = state.apiKey ? 'Â∑≤ËÆæÁΩÆ' : 'Êú™ËÆæÁΩÆ';
      applyTexts(); closeSettings(); render(true);
    });
    $('#btnClearKey').addEventListener('click', ()=>{ state.apiKey=''; localStorage.removeItem('cg_api_key'); els.apiKeyState.textContent='Êú™ËÆæÁΩÆ'; });

    // Wallet
    $('#walletBtn').addEventListener('click', openWallet); $('#walletClose').addEventListener('click', closeWallet);
    $('#btnMetaMask').addEventListener('click', tryMetaMask); $('#btnMock').addEventListener('click', mockAddress);

    // KÁ∫øÔºöÂë®Êúü/Ê†∑Âºè/ÊñπÊ°àÂàáÊç¢
    $('#kClose').addEventListener('click', ()=> close(els.kModal));
    $('#tfSeg').addEventListener('click', async (e)=>{
      const b = e.target.closest('button[data-d]'); if(!b) return;
      [...els.tfSeg.children].forEach(x=>x.classList.remove('is-active')); b.classList.add('is-active');
      currentDays = b.dataset.d; await renderK();
    });
    $('#styleSeg').addEventListener('click', (e)=>{
      const b = e.target.closest('button[data-style]'); if(!b) return;
      [...els.styleSeg.children].forEach(x=>x.classList.remove('is-active')); b.classList.add('is-active');
      state.kStyle = b.dataset.style; localStorage.setItem('k_style', state.kStyle); renderK();
    });
    $('#schemeSeg').addEventListener('click', (e)=>{
      const b = e.target.closest('button[data-s]'); if(!b) return;
      [...els.schemeSeg.children].forEach(x=>x.classList.remove('is-active')); b.classList.add('is-active');
      state.kScheme = b.dataset.s; localStorage.setItem('k_scheme', state.kScheme); renderK();
    });
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ close(els.kModal); closeSettings(); closeWallet(); } });

    /* ========= Init ========= */
    function open(el){ el.classList.remove('hidden'); el.setAttribute('aria-hidden','false'); }
    function close(el){ el.classList.add('hidden'); el.setAttribute('aria-hidden','true'); }
    function openWallet(){ open(els.walletModal); els.walletDetected.textContent = window.ethereum ? 'MetaMask (EIP‚Äë1193) ÂèØÁî®' : 'Êú™Ê£ÄÊµãÂà∞ÊµèËßàÂô®Èí±ÂåÖ'; }
    function closeWallet(){ close(els.walletModal); }
    function openSettings(){ els.apiKeyInput.value = state.apiKey; els.localeSelect.value = state.lang; open(els.settingsModal); }
    function closeSettings(){ close(els.settingsModal); }

    function applyLangActive(){ [...els.langSwitch.children].forEach(b => b.classList.toggle('is-active', b.dataset.lang === state.lang)); }
    function renderGlobalAndList(glob, markets){
      renderGlobal(glob);
      const kw = $('#searchInput').value;
      const data = markets.filter(bySearch(kw)).sort(sorters[state.sort]);
      renderTableRows(data); renderCards(data);
    }

    async function render(force=false){
      applyTexts(); els.apiKeyState.textContent = state.apiKey ? (state.lang==='zh'?'Â∑≤ËÆæÁΩÆ':'Set') : (state.lang==='zh'?'Êú™ËÆæÁΩÆ':'Not set');
      updateWalletUI(); applyLangActive(); if(force){ localStorage.removeItem('cg:markets'); }
      const [glob, markets] = await Promise.all([getGlobal(), getMarkets()]);
      renderGlobalAndList(glob, markets);
    }

    render();
    // ÂìçÂ∫îÂºèÈáçÁªòÔºàÈÅøÂÖçÈ¢ëÁπÅÔºâ
    let tid; window.addEventListener('resize', ()=>{ clearTimeout(tid); tid=setTimeout(()=>{ if(!els.kModal.classList.contains('hidden')) renderK(); }, 200); });
  })();
  </script>
</body>
</html>
