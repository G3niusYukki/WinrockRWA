<!doctype html>
<html lang="zh" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Âä†ÂØÜÂ∏ÇÂú∫ Top 100 / Crypto Top 100</title>
  <meta name="color-scheme" content="light dark">
  <style>
    /* ===== Design tokens ===== */
    :root{
      --bg: radial-gradient(1200px 800px at 10% -10%, #eef5ff 0%, transparent 55%),
            radial-gradient(1000px 700px at 90% 0%, #fff6ee 0%, transparent 45%),
            linear-gradient(180deg, #f8fbff 0%, #f7f7fb 100%);
      --panel: color-mix(in srgb, white 78%, transparent);
      --card: color-mix(in srgb, white 86%, transparent);
      --text: #0f172a; --muted:#475569; --border: rgba(15,23,42,.08);
      --brand:#2563eb; --ok:#16a34a; --down:#ef4444; --warn:#f59e0b;
      --shadow: 0 10px 28px rgba(15,23,42,.10);
      --radius: 14px; --focus: 0 0 0 3px color-mix(in srgb, var(--brand) 30%, transparent);
      --chip: rgba(15,23,42,.05);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg: linear-gradient(180deg,#0b1220,#0d1117);
        --panel: rgba(17,24,39,.5); --card: rgba(17,24,39,.65);
        --text: #e5e7eb; --muted:#94a3b8; --border: rgba(148,163,184,.2);
        --shadow: 0 8px 26px rgba(0,0,0,.35);
        --chip: rgba(255,255,255,.06);
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; color:var(--text); font:16px/1.6 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", "PingFang SC","Noto Sans", Arial, sans-serif; background: var(--bg) fixed}
    a{color:inherit; text-decoration:none}
    .container{max-width:1200px; margin:0 auto; padding:20px}
    @media (max-width:1280px){ .container{padding-inline:16px} }
    @media (max-width:480px){ body{font-size:15px} }

    /* ===== Header / toolbar ===== */
    .app-header{position:sticky; top:0; z-index:20; backdrop-filter:saturate(140%) blur(10px); background:var(--panel); border-bottom:1px solid var(--border)}
    .toolbar{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:nowrap}
    .brand{display:flex; align-items:center; gap:10px; padding:10px 0; font-weight:800; letter-spacing:.2px; min-width:0}
    .badge{display:inline-grid; place-items:center; width:36px; height:36px; border-radius:9px; background:linear-gradient(135deg,#2563eb 0%,#8b5cf6 100%); color:#fff; flex:0 0 auto}
    .brand span{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:38vw}
    .search{flex:1; display:flex; align-items:center; gap:8px; min-width:160px; max-width:520px; background:var(--card); padding:10px 12px; border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow)}
    .search input{flex:1; border:0; outline:0; background:transparent; font-size:15px; color:inherit; min-width:60px}
    .icon-btn{border:0; background:transparent; cursor:pointer; padding:10px; border-radius:10px; touch-action:manipulation}
    .icon-btn:hover{background:rgba(0,0,0,.06)}
    .chip-group{display:flex; gap:6px; background:var(--chip); padding:5px; border-radius:999px}
    .chip{border:0; cursor:pointer; padding:10px 12px; border-radius:999px; background:transparent; color:var(--muted); font-weight:700; touch-action:manipulation}
    .chip.is-active{background:#0f172a; color:#fff; box-shadow:0 6px 20px rgba(16,24,40,.18)}
    @media (prefers-color-scheme: dark){ .chip.is-active{background:#e2e8f0; color:#111827} }

    /* Mobile toolbar wrapping */
    @media (max-width:720px){
      .toolbar{flex-wrap:wrap}
      .brand{order:1; flex:1 1 auto}
      .search{order:3; width:100%}
      .toolbar > .actions-bar{order:2; display:flex; gap:10px; align-items:center}
      #walletBtn{padding:10px 12px}
    }

    /* ===== Hero / global stats ===== */
    .hero{margin:14px 0 10px; display:grid; gap:14px; grid-template-columns: 1.3fr 1fr}
    .panel{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px}
    .stats{display:grid; gap:10px; grid-template-columns: repeat(3,1fr)}
    .stat{display:flex; flex-direction:column; gap:2px}
    .stat .k{font-size:13px; color:var(--muted)}
    .stat .v{font-size:20px; font-weight:900}
    .delta.up{color:var(--ok)} .delta.down{color:var(--down)}
    @media (max-width:920px){ .hero{grid-template-columns:1fr} }
    @media (max-width:600px){ .stats{grid-template-columns:1fr 1fr} .stat .v{font-size:18px} }

    /* ===== Table (desktop / tablet) ===== */
    .table{margin-top:12px; background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); overflow:auto}
    table{width:100%; border-collapse:separate; border-spacing:0; min-width:780px}
    thead th{position:sticky; top:0; background:color-mix(in srgb, var(--card) 90%, transparent); backdrop-filter:blur(6px); font-size:12px; color:var(--muted); text-align:left; padding:10px; border-bottom:1px solid var(--border)}
    tbody td{padding:12px 10px; border-bottom:1px solid var(--border); vertical-align:middle}
    tbody tr:hover{background:rgba(0,0,0,.03)}
    .rank{width:56px; text-align:right; font-variant-numeric:tabular-nums}
    .coin{display:flex; align-items:center; gap:10px}
    .coin img{width:28px; height:28px; border-radius:50%; box-shadow:0 0 0 1px var(--border); background:#fff; object-fit:cover}
    .sym{color:var(--muted); font-size:12px}
    .num{font-variant-numeric:tabular-nums}
    .chg.up{color:var(--ok)} .chg.down{color:var(--down)}
    .spark{width:120px; height:36px}
    .actions{display:flex; gap:8px}
    .btn{display:inline-flex; align-items:center; gap:6px; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#fff; font-weight:700; cursor:pointer; touch-action:manipulation}
    .btn.primary{background:var(--brand); color:#fff; border-color:transparent}
    @media (prefers-color-scheme: dark){ .btn{background:#0b1220; color:#e5e7eb} }

    /* ===== Mobile Cards (<=768px) ===== */
    .cards{display:none}
    @media (max-width:768px){
      .table{display:none}
      .cards{display:grid; gap:12px}
      .item{display:flex; flex-direction:column; gap:8px; background:var(--card); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:12px}
      .row1{display:flex; align-items:center; gap:10px; justify-content:space-between}
      .left{display:flex; align-items:center; gap:10px; min-width:0}
      .rank-badge{font-variant-numeric:tabular-nums; font-weight:800; width:28px; text-align:right}
      .coin img{width:26px; height:26px}
      .name{font-weight:800; max-width:44vw; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
      .sym{font-size:12px}
      .price{font-weight:900}
      .row2{display:grid; grid-template-columns: repeat(4, auto); gap:10px; align-items:center; font-size:13px}
      .kv{display:flex; flex-direction:column; gap:2px}
      .kv .k{color:var(--muted); font-size:12px}
      .spark{width:100%; height:34px}
      .actions{margin-top:6px}
      @media (max-width:420px){
        .row2{grid-template-columns: repeat(2, 1fr)}
        .spark{display:none}
      }
    }

    /* ===== Modals ===== */
    .modal{position:fixed; inset:0; background:rgba(0,0,0,.45); display:flex; align-items:center; justify-content:center; padding:22px}
    .hidden{display:none}
    .modal-card{width:min(680px,100%); background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:0 30px 80px rgba(0,0,0,.35); overflow:hidden}
    .modal-head{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--border)}
    .modal-body{padding:16px}
    .form{display:grid; gap:12px}
    label{font-size:13px; color:var(--muted)}
    input, select{width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:transparent; color:inherit}
    input:focus, select:focus{outline:none; box-shadow:var(--focus)}

    footer{color:#94a3b8; font-size:12px; text-align:center; margin:18px 0}
    /* Motion reduce */
    @media (prefers-reduced-motion: reduce){
      *{animation:none !important; transition:none !important}
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="app-header">
    <div class="container toolbar" role="navigation" aria-label="Top Navigation">
      <div class="brand">
        <span class="badge" aria-hidden="true">‚Çø</span>
        <span id="i-brand">Âä†ÂØÜÂ∏ÇÂú∫ Top 100</span>
      </div>

      <div class="search" role="search">
        <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M15.5 14h-.79l-.28-.27a6.471 6.471 0 0 0 1.57-4.23A6.5 6.5 0 1 0 9.5 16a6.471 6.471 0 0 0 4.23-1.57l.27.28v.79l 4.25 4.25c.41.41 1.08.41 1.49 0s.41-1.08 0-1.49L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
        <input id="searchInput" type="search" placeholder="ÊêúÁ¥¢Â∏ÅÁßç / Search‚Ä¶" aria-label="Search coins" inputmode="search" />
        <button id="clearSearch" class="icon-btn" title="Clear" aria-label="Clear search">‚úï</button>
      </div>

      <div class="actions-bar" style="display:flex; align-items:center; gap:10px">
        <div class="chip-group" id="langSwitch" role="tablist" aria-label="Language">
          <button class="chip is-active" role="tab" data-lang="zh">‰∏≠Êñá</button>
          <button class="chip" role="tab" data-lang="en">EN</button>
        </div>
        <button id="walletBtn" class="btn primary">üëú <span id="i-connect">ËøûÊé•Èí±ÂåÖ</span></button>
        <button id="settingsBtn" class="btn" title="API Key & ËÆæÁΩÆ">‚öôÔ∏è</button>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <div class="container">
    <section class="hero">
      <div class="panel">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap">
          <h2 style="margin:0" id="i-marketOverview">Â∏ÇÂú∫Ê¶ÇËßà</h2>
          <div class="actions" style="display:flex; gap:8px; flex-wrap:wrap">
            <button class="btn" id="refreshBtn">‚ü≤ <span id="i-refresh">Âà∑Êñ∞</span></button>
            <div class="chip-group" id="sortSwitch" aria-label="Sort">
              <button class="chip is-active" data-sort="mcap">MC</button>
              <button class="chip" data-sort="price">Price</button>
              <button class="chip" data-sort="change24h">24h</button>
            </div>
          </div>
        </div>
        <div class="stats" style="margin-top:10px">
          <div class="stat"><div class="k" id="i-gcap">ÂÖ®ÁêÉÊÄªÂ∏ÇÂÄº</div><div class="v" id="gcap">‚Äî</div></div>
          <div class="stat"><div class="k" id="i-gdelta">24Â∞èÊó∂ÂèòÂä®</div><div class="v delta" id="gdelta">‚Äî</div></div>
          <div class="stat"><div class="k" id="i-btcdom">BTC Âç†ÊØî</div><div class="v" id="btcdom">‚Äî</div></div>
        </div>
      </div>
      <div class="panel">
        <div class="stat">
          <div class="k" id="i-apiKeyLabel">CoinGecko API Key</div>
          <div class="v" id="apiKeyState">Êú™ËÆæÁΩÆ</div>
        </div>
        <p class="helper" id="i-apiHelp">
          ‰ΩøÁî®ÂÖ¨ÂºÄ Demo Key ‰πüÂèØ‰ª•Ôºà‰ªÖÈôêÈÄü‰∏çÂêåÔºâ„ÄÇÊú™ËÆæÁΩÆÊó∂‰ªçÂèØÂ∞ùËØïÂõûÈÄÄÊï∞ÊçÆ„ÄÇ
        </p>
        <div class="actions">
          <button class="btn" id="openKey" style="width:100%">üîë <span id="i-openKey">ËÆæÁΩÆ / Êõ¥Êç¢ Key</span></button>
        </div>
      </div>
    </section>

    <!-- Desktop/Table -->
    <section class="table" aria-label="Top 100 cryptocurrencies (table)">
      <table>
        <thead>
          <tr>
            <th class="rank">#</th>
            <th id="i-col-coin">Â∏ÅÁßç</th>
            <th id="i-col-price">‰ª∑Ê†º(USD)</th>
            <th id="i-col-mcap">Â∏ÇÂÄº</th>
            <th id="i-col-24h">24h</th>
            <th id="i-col-7d">7d</th>
            <th id="i-col-vol">Êàê‰∫§È¢ù(24h)</th>
            <th id="i-col-act">Êìç‰Ωú</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>

    <!-- Mobile/Cards -->
    <section class="cards" aria-label="Top 100 cryptocurrencies (cards)">
      <div id="cardList" role="list"></div>
    </section>

    <footer id="i-disclaimer">
      * Êï∞ÊçÆÊ∫ê‰ºòÂÖà CoinGeckoÔºàÈúÄ API KeyÔºâÔºåÂ§±Ë¥•Êó∂ÈÄÄÂåñÂà∞ CoinCap Âü∫Á°ÄÊï∞ÊçÆ/ÂõæÊ†á„ÄÇÂâçÁ´ØÂÅö‰∫ÜÊú¨Âú∞ÁºìÂ≠òÂíåÈ¢ëÁéáÊéßÂà∂ÔºõËØ∑Âú®ÁúüÂÆû‰∫ßÂìÅ‰∏≠Êää Key ÊîæÂà∞ÂêéÁ´Ø‰ª£ÁêÜÊõ¥ÂÆâÂÖ®„ÄÇ
    </footer>
  </div>

  <!-- Wallet Modal -->
  <div id="walletModal" class="modal hidden" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="walletTitle">
      <div class="modal-head">
        <h3 id="walletTitle">ËøûÊé•Èí±ÂåÖ</h3>
        <button class="icon-btn" id="walletClose" aria-label="Close">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="form">
          <div>
            <label id="i-walletDetected">Ê£ÄÊµãÂà∞ÁöÑÈí±ÂåÖ</label>
            <div id="walletDetectResult" class="helper">‚Äî</div>
          </div>
          <div>
            <button class="btn primary" id="btnMetaMask">ü¶ä <span id="i-useMetaMask">‰ΩøÁî® MetaMask</span></button>
          </div>
          <div>
            <button class="btn" id="btnMock">üéõÔ∏è <span id="i-useMock">‰ΩøÁî®Ê®°ÊãüÂú∞ÂùÄ</span></button>
            <div class="helper" id="i-mockNote">Áî®‰∫éËÅîË∞ÉÁöÑÂç†‰ΩçÊñπÊ°àÔºå‰∏ç‰ºö‰∫ßÁîüÁúüÂÆûÈìæ‰∏ä‰∫§‰∫í„ÄÇ</div>
          </div>
          <div>
            <label id="i-walletAddr">ÂΩìÂâçÂú∞ÂùÄ</label>
            <input id="currentAddr" readonly placeholder="0x‚Ä¶"/>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal hidden" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
      <div class="modal-head">
        <h3 id="settingsTitle">ËÆæÁΩÆ</h3>
        <button class="icon-btn" id="settingsClose" aria-label="Close">‚úï</button>
      </div>
      <div class="modal-body">
        <form id="settingsForm" class="form" novalidate>
          <div>
            <label for="apiKeyInput">CoinGecko API Key</label>
            <input id="apiKeyInput" placeholder="Á≤òË¥¥‰Ω†ÁöÑ x-cg-demo-api-key" />
            <div class="helper" id="i-keyHelper">Âª∫ËÆÆÁî®ËØ∑Ê±ÇÂ§¥ÊñπÂºèÔºàÊõ¥ÂÆâÂÖ®ÔºâÔºõ‰πüÊîØÊåÅ query ÂèÇÊï∞„ÄÇ‰ªÖÂÅöÊºîÁ§∫Â≠òÂÇ®Âú®Êú¨Âú∞„ÄÇ</div>
          </div>
          <div>
            <label for="localeSelect" id="i-langLabel">ÁïåÈù¢ËØ≠Ë®Ä</label>
            <select id="localeSelect">
              <option value="zh">‰∏≠Êñá</option>
              <option value="en">English</option>
            </select>
          </div>
          <div class="actions" style="justify-content:flex-end">
            <button type="button" class="btn" id="btnClearKey">Ê∏ÖÈô§ Key</button>
            <button type="submit" class="btn primary" id="btnSaveSettings">‰øùÂ≠ò</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <template id="row">
    <tr>
      <td class="rank num">1</td>
      <td>
        <div class="coin">
          <img alt="logo" loading="lazy" referrerpolicy="no-referrer" />
          <div>
            <div class="name">Bitcoin</div>
            <div class="sym">BTC</div>
          </div>
        </div>
      </td>
      <td class="num price">$‚Äî</td>
      <td class="num mcap">$‚Äî</td>
      <td class="num chg chg24">‚Äî</td>
      <td>
        <svg class="spark" viewBox="0 0 120 36" preserveAspectRatio="none" aria-hidden="true"></svg>
        <div class="num chg chg7" style="font-size:12px; margin-top:2px">‚Äî</div>
      </td>
      <td class="num vol">$‚Äî</td>
      <td>
        <div class="actions">
          <a class="btn" target="_blank" rel="noopener" data-role="open">üîé <span class="i-open">ËØ¶ÊÉÖ</span></a>
        </div>
      </td>
    </tr>
  </template>

  <template id="cardItem">
    <article class="item" role="listitem">
      <div class="row1">
        <div class="left">
          <div class="rank-badge">#<span class="rank">1</span></div>
          <div class="coin">
            <img alt="logo" loading="lazy" referrerpolicy="no-referrer" />
            <div>
              <div class="name">Bitcoin</div>
              <div class="sym">BTC</div>
            </div>
          </div>
        </div>
        <div class="price">$‚Äî</div>
      </div>
      <div class="row2">
        <div class="kv"><div class="k">24h</div><div class="v chg chg24">‚Äî</div></div>
        <div class="kv"><div class="k">7d</div><div class="v chg chg7">‚Äî</div></div>
        <div class="kv"><div class="k">MCap</div><div class="v mcap">$‚Äî</div></div>
        <div class="kv"><div class="k">Vol</div><div class="v vol">$‚Äî</div></div>
      </div>
      <svg class="spark" viewBox="0 0 120 36" preserveAspectRatio="none" aria-hidden="true"></svg>
      <div class="actions">
        <a class="btn" target="_blank" rel="noopener" data-role="open">üîé <span class="i-open">ËØ¶ÊÉÖ</span></a>
      </div>
    </article>
  </template>

  <script>
  ;(() => {
    /* ========= i18n ========= */
    const i18n = {
      zh: {
        brand:"Âä†ÂØÜÂ∏ÇÂú∫ Top 100",
        search_placeholder:"ÊêúÁ¥¢Â∏ÅÁßç / Search‚Ä¶",
        marketOverview:"Â∏ÇÂú∫Ê¶ÇËßà",
        refresh:"Âà∑Êñ∞",
        gcap:"ÂÖ®ÁêÉÊÄªÂ∏ÇÂÄº",
        gdelta:"24Â∞èÊó∂ÂèòÂä®",
        btcdom:"BTC Âç†ÊØî",
        apiKeyLabel:"CoinGecko API Key",
        apiHelp:"‰ΩøÁî®ÂÖ¨ÂºÄ Demo Key ‰πüÂèØ‰ª•Ôºà‰ªÖÈôêÈÄü‰∏çÂêåÔºâ„ÄÇÊú™ËÆæÁΩÆÊó∂‰ªçÂèØÂ∞ùËØïÂõûÈÄÄÊï∞ÊçÆ„ÄÇ",
        openKey:"ËÆæÁΩÆ / Êõ¥Êç¢ Key",
        col:{coin:"Â∏ÅÁßç", price:"‰ª∑Ê†º(USD)", mcap:"Â∏ÇÂÄº", d24:"24h", d7:"7d", vol:"Êàê‰∫§È¢ù(24h)", act:"Êìç‰Ωú"},
        connect:"ËøûÊé•Èí±ÂåÖ",
        wallet:{title:"ËøûÊé•Èí±ÂåÖ", detected:"Ê£ÄÊµãÂà∞ÁöÑÈí±ÂåÖ", useMM:"‰ΩøÁî® MetaMask", useMock:"‰ΩøÁî®Ê®°ÊãüÂú∞ÂùÄ", mockNote:"Áî®‰∫éËÅîË∞ÉÁöÑÂç†‰ΩçÊñπÊ°àÔºå‰∏ç‰ºö‰∫ßÁîüÁúüÂÆûÈìæ‰∏ä‰∫§‰∫í„ÄÇ", addr:"ÂΩìÂâçÂú∞ÂùÄ"},
        settings:{title:"ËÆæÁΩÆ", keyHelper:"Âª∫ËÆÆÁî®ËØ∑Ê±ÇÂ§¥ÊñπÂºèÔºàÊõ¥ÂÆâÂÖ®ÔºâÔºõ‰πüÊîØÊåÅ query ÂèÇÊï∞„ÄÇ‰ªÖÂÅöÊºîÁ§∫Â≠òÂÇ®Âú®Êú¨Âú∞„ÄÇ", langLabel:"ÁïåÈù¢ËØ≠Ë®Ä", save:"‰øùÂ≠ò", clearKey:"Ê∏ÖÈô§ Key"},
        open:"ËØ¶ÊÉÖ",
        disclaimer:"* Êï∞ÊçÆÊ∫ê‰ºòÂÖà CoinGeckoÔºàÈúÄ API KeyÔºâÔºåÂ§±Ë¥•Êó∂ÈÄÄÂåñÂà∞ CoinCap Âü∫Á°ÄÊï∞ÊçÆ/ÂõæÊ†á„ÄÇËØ∑Âú®ÁúüÂÆû‰∫ßÂìÅ‰∏≠Â∞Ü Key ‰∏ãÂèëÂà∞ÂêéÁ´Ø‰ª£ÁêÜ„ÄÇ"
      },
      en: {
        brand:"Crypto Market Top 100",
        search_placeholder:"Search coins‚Ä¶",
        marketOverview:"Market Overview",
        refresh:"Refresh",
        gcap:"Global Mkt Cap",
        gdelta:"24h Change",
        btcdom:"BTC Dominance",
        apiKeyLabel:"CoinGecko API Key",
        apiHelp:"Demo key works too (lower rate limit). Fallback data without key is attempted.",
        openKey:"Set / Change Key",
        col:{coin:"Coin", price:"Price(USD)", mcap:"Mkt Cap", d24:"24h", d7:"7d", vol:"Volume(24h)", act:"Action"},
        connect:"Connect Wallet",
        wallet:{title:"Connect Wallet", detected:"Detected Wallets", useMM:"Use MetaMask", useMock:"Use Mock Address", mockNote:"For dev only. No real on‚Äëchain tx.", addr:"Current Address"},
        settings:{title:"Settings", keyHelper:"Header usage recommended; query param also supported. Saved locally for demo.", langLabel:"Language", save:"Save", clearKey:"Clear Key"},
        open:"Details",
        disclaimer:"* Primary source: CoinGecko (requires API key). Falls back to CoinCap basics/icons if needed. In production, proxy keys via your backend."
      }
    }
    const state = {
      lang: localStorage.getItem('lang') || 'zh',
      sort: 'mcap',
      apiKey: localStorage.getItem('cg_api_key') || '',
      cacheTTL: 60_000,
      globalTTL: 10*60_000,
      wallet: localStorage.getItem('wallet_addr') || ''
    };
    const t = (path) => path.split('.').reduce((o,k)=>o?.[k], i18n[state.lang]) ?? path;
    document.documentElement.lang = state.lang;

    /* ========= DOM ========= */
    const $ = sel => document.querySelector(sel);
    const els = {
      brand: $('#i-brand'),
      search: $('#searchInput'),
      clear: $('#clearSearch'),
      langSwitch: $('#langSwitch'),
      sortSwitch: $('#sortSwitch'),
      refresh: $('#refreshBtn'),
      tbody: $('#tbody'),
      cardList: $('#cardList'),
      gcap: $('#gcap'), gdelta: $('#gdelta'), btcdom: $('#btcdom'),
      i:{ marketOverview: $('#i-marketOverview'), refresh: $('#i-refresh'), gcap: $('#i-gcap'), gdelta: $('#i-gdelta'), btcdom: $('#i-btcdom'),
          apiKeyLabel: $('#i-apiKeyLabel'), apiHelp: $('#i-apiHelp'), openKey: $('#i-openKey'),
          colCoin: $('#i-col-coin'), colPrice: $('#i-col-price'), colMcap: $('#i-col-mcap'), col24: $('#i-col-24h'), col7: $('#i-col-7d'), colVol: $('#i-col-vol'), colAct: $('#i-col-act'),
          connect: $('#i-connect')
      },
      apiKeyState: $('#apiKeyState'), openKey: $('#openKey'),
      settingsBtn: $('#settingsBtn'), settingsModal: $('#settingsModal'), settingsClose: $('#settingsClose'),
      settingsForm: $('#settingsForm'), apiKeyInput: $('#apiKeyInput'), localeSelect: $('#localeSelect'),
      btnClearKey: $('#btnClearKey'), btnSaveSettings: $('#btnSaveSettings'),
      disclaimer: $('#i-disclaimer'),

      walletBtn: $('#walletBtn'), walletModal: $('#walletModal'), walletClose: $('#walletClose'),
      btnMetaMask: $('#btnMetaMask'), btnMock: $('#btnMock'),
      walletDetected: $('#walletDetectResult'), currAddr: $('#currentAddr'),
      walletTitle: $('#walletTitle'), iWalletDetected: $('#i-walletDetected'), iUseMM: $('#i-useMetaMask'), iUseMock: $('#i-useMock'), iMockNote: $('#i-mockNote'), iWalletAddr: $('#i-walletAddr')
    };

    /* ========= Utils ========= */
    const locale = () => state.lang === 'zh' ? 'zh-CN' : 'en-US';
    const nf = (opts) => new Intl.NumberFormat(locale(), opts);
    const fmtUSD = v => (v==null? '‚Äî' : nf({style:'currency', currency:'USD', maximumFractionDigits: v>100?0: v>1?2: 6}).format(v));
    const fmtPct = v => (v==null? '‚Äî' : (v>=0? '+' : '') + nf({maximumFractionDigits:2}).format(v) + '%');
    const shortNum = n => {
      if(n==null) return '‚Äî';
      const abs = Math.abs(n);
      const units = [{k:1e12,s:'T'},{k:1e9,s:'B'},{k:1e6,s:'M'},{k:1e3,s:'K'}];
      for(const u of units){ if(abs>=u.k) return (n/u.k).toFixed(abs>=10*u.k?1:2)+u.s; }
      return nf({maximumFractionDigits:0}).format(n);
    };
    const el = (html) => { const d=document.createElement('div'); d.innerHTML=html.trim(); return d.firstChild; };

    /* ========= Fetch layer (with cache & fallback) ========= */
    const withHeaders = (init={}) => {
      const headers = new Headers(init.headers || {});
      headers.set('accept','application/json');
      if(state.apiKey) headers.set('x-cg-demo-api-key', state.apiKey);
      return {...init, headers};
    };
    const cacheGet = (k, ttl) => {
      try{
        const it = JSON.parse(localStorage.getItem(k) || 'null');
        if(!it) return null;
        if(Date.now() - it.ts > ttl) return null;
        return it.data;
      }catch{ return null; }
    };
    const cacheSet = (k, data) => localStorage.setItem(k, JSON.stringify({ts:Date.now(), data}));

    async function getMarkets(){
      const CK = 'cg:markets';
      const cached = cacheGet(CK, state.cacheTTL);
      if(cached) return cached;
      const qs = new URLSearchParams({
        vs_currency:'usd', order:'market_cap_desc', per_page:'100', page:'1',
        sparkline:'true', price_change_percentage:'24h,7d'
      });
      if(state.apiKey) qs.set('x_cg_demo_api_key', state.apiKey);
      const url = `https://api.coingecko.com/api/v3/coins/markets?`+qs.toString();
      try{
        const res = await fetch(url, withHeaders());
        if(!res.ok) throw new Error('coingecko '+res.status);
        const data = await res.json();
        cacheSet(CK, data);
        return data;
      }catch(e){
        console.warn('[fallback] CoinGecko failed:', e);
        return await getMarketsFallback();
      }
    }
    async function getGlobal(){
      const CK = 'cg:global';
      const cached = cacheGet(CK, state.globalTTL);
      if(cached) return cached;
      const qs = new URLSearchParams();
      if(state.apiKey) qs.set('x_cg_demo_api_key', state.apiKey);
      try{
        const res = await fetch(`https://api.coingecko.com/api/v3/global?${qs}`, withHeaders());
        if(!res.ok) throw new Error('coingecko-global '+res.status);
        const data = await res.json();
        cacheSet(CK, data);
        return data;
      }catch(e){
        console.warn('[fallback] global failed:', e);
        return null;
      }
    }
    // Fallback: CoinCapÔºàÂü∫Á°ÄÂ≠óÊÆµ + ÂõæÊ†áÊé®Êñ≠Ôºâ
    async function getMarketsFallback(){
      try{
        const res = await fetch('https://api.coincap.io/v2/assets?limit=100');
        if(!res.ok) throw new Error('coincap '+res.status);
        const { data } = await res.json();
        return data.map((it, i) => ({
          market_cap_rank: i+1,
          id: it.id,
          symbol: it.symbol?.toLowerCase(),
          name: it.name,
          image: `https://assets.coincap.io/assets/icons/${(it.symbol||'').toLowerCase()}@2x.png`,
          current_price: Number(it.priceUsd),
          market_cap: Number(it.marketCapUsd),
          total_volume: Number(it.volumeUsd24Hr),
          price_change_percentage_24h: Number(it.changePercent24Hr),
          sparkline_in_7d: { price: [] },
          price_change_percentage_7d_in_currency: null
        }));
      }catch(err){
        console.error('Fallback failed:', err);
        return [];
      }
    }

    /* ========= Render ========= */
    function applyTexts(){
      els.brand.textContent = t('brand');
      els.search.placeholder = t('search_placeholder');
      els.i.marketOverview.textContent = t('marketOverview');
      els.i.refresh.textContent = t('refresh');
      els.i.gcap.textContent = t('gcap');
      els.i.gdelta.textContent = t('gdelta');
      els.i.btcdom.textContent = t('btcdom');
      $('#i-apiKeyLabel').textContent = t('apiKeyLabel');
      $('#i-apiHelp').textContent = t('apiHelp');
      $('#i-openKey').textContent = t('openKey');
      $('#i-col-coin').textContent = t('col.coin');
      $('#i-col-price').textContent = t('col.price');
      $('#i-col-mcap').textContent = t('col.mcap');
      $('#i-col-24h').textContent = t('col.d24');
      $('#i-col-7d').textContent = t('col.d7');
      $('#i-col-vol').textContent = t('col.vol');
      $('#i-col-act').textContent = t('col.act');
      els.i.connect.textContent = t('connect');
      $('#settingsTitle').textContent = t('settings.title');
      $('#i-keyHelper').textContent = t('settings.keyHelper');
      $('#i-langLabel').textContent = t('settings.langLabel');
      els.btnSaveSettings.textContent = t('settings.save');
      els.btnClearKey.textContent = t('settings.clearKey');
      // wallet texts
      $('#walletTitle').textContent = t('wallet.title');
      $('#i-walletDetected').textContent = t('wallet.detected');
      $('#i-useMetaMask').textContent = t('wallet.useMM');
      $('#i-useMock').textContent = t('wallet.useMock');
      $('#i-mockNote').textContent = t('wallet.mockNote');
      $('#i-walletAddr').textContent = t('wallet.addr');
      document.querySelectorAll('.i-open').forEach(n=>n.textContent = t('open'));
      els.disclaimer.textContent = t('disclaimer');
      document.documentElement.lang = state.lang;
    }

    function renderGlobal(glob){
      if(!glob?.data){ els.gcap.textContent='‚Äî'; els.gdelta.textContent='‚Äî'; els.btcdom.textContent='‚Äî'; return; }
      const d = glob.data;
      const cap = d.total_market_cap?.usd;
      const delta = d.market_cap_change_percentage_24h_usd;
      const btc = d.market_cap_percentage?.btc;
      els.gcap.textContent = fmtUSD(cap);
      els.gdelta.textContent = fmtPct(delta);
      els.gdelta.className = 'v delta ' + (delta>=0?'up':'down');
      els.btcdom.textContent = (btc!=null? nf({maximumFractionDigits:2}).format(btc) + '%' : '‚Äî');
    }

    function drawSpark(svg, prices){
      const w = 120, h = 36, pad=2;
      svg.setAttribute('viewBox',`0 0 ${w} ${h}`);
      svg.innerHTML = '';
      if(!prices || prices.length<2) return;
      const min = Math.min(...prices), max = Math.max(...prices);
      const xs = prices.map((_,i)=> pad + (i*(w-2*pad)/(prices.length-1)));
      const ys = prices.map(v => {
        if(max===min) return h/2;
        return pad + (h-2*pad) - ( (v-min)/(max-min) * (h-2*pad) );
      });
      const d = xs.map((x,i)=> `${i?'L':'M'}${x.toFixed(2)},${ys[i].toFixed(2)}`).join(' ');
      const path = document.createElementNS('http://www.w3.org/2000/svg','path');
      path.setAttribute('d', d);
      path.setAttribute('fill','none'); path.setAttribute('stroke','currentColor'); path.setAttribute('stroke-width','1.5');
      svg.appendChild(path);
    }

    // === Table rows (desktop) ===
    function renderTableRows(data){
      els.tbody.innerHTML = '';
      const tpl = document.getElementById('row');
      const frag = document.createDocumentFragment();
      data.forEach((p,idx)=>{
        const node = tpl.content.cloneNode(true);
        node.querySelector('.rank').textContent = p.market_cap_rank ?? (idx+1);
        const img = node.querySelector('img');
        img.src = p.image || `https://assets.coincap.io/assets/icons/${(p.symbol||'').toLowerCase()}@2x.png`;
        img.alt = `${p.name} logo`;
        img.onerror = () => { img.onerror=null; img.src=`https://assets.coincap.io/assets/icons/${(p.symbol||'').toLowerCase()}@2x.png`; };

        node.querySelector('.name').textContent = p.name;
        node.querySelector('.sym').textContent = (p.symbol || '').toUpperCase();

        node.querySelector('.price').textContent = fmtUSD(p.current_price);
        node.querySelector('.mcap').textContent = '$'+ shortNum(p.market_cap);
        const c24 = p.price_change_percentage_24h;
        const el24 = node.querySelector('.chg24'); el24.textContent = fmtPct(c24); el24.classList.add(c24>=0?'up':'down');

        const c7 = p.price_change_percentage_7d_in_currency ?? p.price_change_percentage_7d ?? null;
        const el7 = node.querySelector('.chg7'); el7.textContent = c7==null? '‚Äî' : fmtPct(c7); el7.classList.add(c7>=0?'up':'down');

        const prices = p.sparkline_in_7d?.price;
        drawSpark(node.querySelector('.spark'), prices);

        node.querySelector('.vol').textContent = '$'+ shortNum(p.total_volume);

        const loc = state.lang==='zh' ? 'zh' : 'en';
        node.querySelector('[data-role="open"]').href = `https://www.coingecko.com/${loc}/coins/${p.id}`;

        frag.appendChild(node);
      });
      els.tbody.appendChild(frag);
    }

    // === Cards (mobile) ===
    function renderCards(data){
      els.cardList.innerHTML = '';
      const tpl = document.getElementById('cardItem');
      const frag = document.createDocumentFragment();
      data.forEach((p,idx)=>{
        const node = tpl.content.cloneNode(true);
        node.querySelector('.rank').textContent = p.market_cap_rank ?? (idx+1);
        const img = node.querySelector('img');
        img.src = p.image || `https://assets.coincap.io/assets/icons/${(p.symbol||'').toLowerCase()}@2x.png`;
        img.alt = `${p.name} logo`;
        img.onerror = () => { img.onerror=null; img.src=`https://assets.coincap.io/assets/icons/${(p.symbol||'').toLowerCase()}@2x.png`; };

        node.querySelector('.name').textContent = p.name;
        node.querySelector('.sym').textContent = (p.symbol || '').toUpperCase();
        node.querySelector('.price').textContent = fmtUSD(p.current_price);

        const c24 = p.price_change_percentage_24h;
        const el24 = node.querySelector('.chg24'); el24.textContent = fmtPct(c24); el24.classList.add(c24>=0?'up':'down');

        const c7 = p.price_change_percentage_7d_in_currency ?? p.price_change_percentage_7d ?? null;
        const el7 = node.querySelector('.chg7'); el7.textContent = c7==null? '‚Äî' : fmtPct(c7); el7.classList.add(c7>=0?'up':'down');

        node.querySelector('.mcap').textContent = '$'+ shortNum(p.market_cap);
        node.querySelector('.vol').textContent = '$'+ shortNum(p.total_volume);

        const prices = p.sparkline_in_7d?.price;
        drawSpark(node.querySelector('.spark'), prices);

        const loc = state.lang==='zh' ? 'zh' : 'en';
        node.querySelector('[data-role="open"]').href = `https://www.coingecko.com/${loc}/coins/${p.id}`;

        frag.appendChild(node);
      });
      els.cardList.appendChild(frag);
    }

    /* ========= Filters & sort ========= */
    function bySearch(kw){
      if(!kw) return () => true;
      kw = kw.trim().toLowerCase();
      return p => (p.name?.toLowerCase().includes(kw) || p.symbol?.toLowerCase().includes(kw));
    }
    const sorters = {
      mcap: (a,b) => (b.market_cap??0)-(a.market_cap??0),
      price: (a,b) => (b.current_price??0)-(a.current_price??0),
      change24h: (a,b) => (b.price_change_percentage_24h??-1e9)-(a.price_change_percentage_24h??-1e9)
    };

    /* ========= Wallet mock ========= */
    function updateWalletUI(){
      const label = state.wallet ? (state.wallet.slice(0,6)+'‚Ä¶'+state.wallet.slice(-4)) : t('connect');
      els.walletBtn.querySelector('span').textContent = label;
      els.currAddr.value = state.wallet || '';
    }
    async function tryMetaMask(){
      const eth = window.ethereum;
      if(!eth){ alert(state.lang==='zh'?'Êú™Ê£ÄÊµãÂà∞ MetaMask Êàñ EIP‚Äë1193 Èí±ÂåÖ„ÄÇ':'No MetaMask / EIP‚Äë1193 wallet detected.'); return; }
      try{
        const accts = await eth.request({ method:'eth_requestAccounts' });
        const addr = (accts && accts[0]) || '';
        if(addr){
          state.wallet = addr; localStorage.setItem('wallet_addr', addr);
          updateWalletUI(); closeWallet();
          // È¢ÑÁïôÁúüÂÆûÊé•ÂÖ•ÁÇπÔºö
          // fetch('/api/wallet/connect', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ address: addr, ts: Date.now() }) })
          console.log('[RFQ wallet] connected:', addr);
        }
      }catch(err){ console.warn('MetaMask rejected/failed', err); }
    }
    function mockAddress(){
      const hex = Array.from(crypto.getRandomValues(new Uint8Array(20))).map(b=>b.toString(16).padStart(2,'0')).join('');
      const addr = '0x'+hex;
      state.wallet = addr; localStorage.setItem('wallet_addr', addr);
      updateWalletUI(); closeWallet();
      console.log('[RFQ wallet MOCK] connected:', addr);
    }

    /* ========= Modals ========= */
    function open(el){ el.classList.remove('hidden'); el.setAttribute('aria-hidden','false'); }
    function close(el){ el.classList.add('hidden'); el.setAttribute('aria-hidden','true'); }
    function openWallet(){ open(els.walletModal); els.walletDetected.textContent = window.ethereum ? 'MetaMask (EIP‚Äë1193) ÂèØÁî®' : 'Êú™Ê£ÄÊµãÂà∞ÊµèËßàÂô®Èí±ÂåÖ'; }
    function closeWallet(){ close(els.walletModal); }
    function openSettings(){ els.apiKeyInput.value = state.apiKey; els.localeSelect.value = state.lang; open(els.settingsModal); }
    function closeSettings(){ close(els.settingsModal); }

    /* ========= Events ========= */
    els.langSwitch.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-lang]'); if(!btn) return;
      [...els.langSwitch.children].forEach(b=>b.classList.remove('is-active')); btn.classList.add('is-active');
      state.lang = btn.dataset.lang; localStorage.setItem('lang', state.lang);
      applyTexts(); render(true);
    });
    els.sortSwitch.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-sort]'); if(!btn) return;
      [...els.sortSwitch.children].forEach(b=>b.classList.remove('is-active')); btn.classList.add('is-active');
      state.sort = btn.dataset.sort; render();
    });
    els.search.addEventListener('input', render);
    els.clear.addEventListener('click', ()=>{ els.search.value=''; render(); });
    els.refresh.addEventListener('click', async()=>{ localStorage.removeItem('cg:markets'); await render(true); });

    // settings
    els.settingsBtn.addEventListener('click', openSettings); els.openKey.addEventListener('click', openSettings);
    els.settingsClose.addEventListener('click', closeSettings);
    els.settingsForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      state.apiKey = els.apiKeyInput.value.trim(); localStorage.setItem('cg_api_key', state.apiKey);
      state.lang = els.localeSelect.value; localStorage.setItem('lang', state.lang);
      els.apiKeyState.textContent = state.apiKey ? 'Â∑≤ËÆæÁΩÆ' : 'Êú™ËÆæÁΩÆ';
      applyTexts(); closeSettings(); render(true);
    });
    els.btnClearKey.addEventListener('click', ()=>{ state.apiKey=''; localStorage.removeItem('cg_api_key'); els.apiKeyState.textContent='Êú™ËÆæÁΩÆ'; });

    // wallet
    els.walletBtn.addEventListener('click', openWallet); els.walletClose.addEventListener('click', closeWallet);
    els.btnMetaMask.addEventListener('click', tryMetaMask); els.btnMock.addEventListener('click', mockAddress);
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closeWallet(); closeSettings(); } });

    /* ========= Main render ========= */
    function isMobile(){ return window.matchMedia('(max-width: 768px)').matches; }

    async function render(force=false){
      applyTexts();
      els.apiKeyState.textContent = state.apiKey ? (state.lang==='zh'?'Â∑≤ËÆæÁΩÆ':'Set') : (state.lang==='zh'?'Êú™ËÆæÁΩÆ':'Not set');
      updateWalletUI();
      if(force){ localStorage.removeItem('cg:markets'); }
      const [glob, marketsRaw] = await Promise.all([getGlobal(), getMarkets()]);
      renderGlobal(glob);
      // filter/sort
      const kw = els.search.value;
      const data = marketsRaw.filter(bySearch(kw)).sort(sorters[state.sort]);
      // render both containers; CSSÂÜ≥ÂÆöÊòæÁ§∫Ë∞Å
      renderTableRows(data);
      renderCards(data);
    }

    // init + re-render on layout changeÔºàÈÅøÂÖçÈ¢ëÁπÅÔºåÂÅö‰∏Ä‰∏™ÁÆÄÂçïËäÇÊµÅÔºâ
    let lastMobile = isMobile(), rAF;
    window.addEventListener('resize', () => {
      if(isMobile() !== lastMobile){
        lastMobile = !lastMobile;
        cancelAnimationFrame(rAF);
        rAF = requestAnimationFrame(()=> render());
      }
    });

    ;[...els.langSwitch.children].forEach(b => b.classList.toggle('is-active', b.dataset.lang === state.lang));
    els.apiKeyState.textContent = state.apiKey ? 'Â∑≤ËÆæÁΩÆ' : 'Êú™ËÆæÁΩÆ';
    render();
  })();
  </script>
</body>
</html>
